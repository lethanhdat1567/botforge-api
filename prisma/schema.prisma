generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
}

// =====================
// User
// =====================
model User {
  id           String   @id @default(uuid()) @map("id")
  username     String   @unique @map("username")
  displayName  String?  @map("display_name")
  email        String   @unique @map("email")
  avatar String? @db.Text @map("avatar")
  password     String   @map("password")
  role         Role     @default(user) @map("role")
  provider     Provider @default(local) @map("provider")
  providerId   String?  @map("provider_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @default(now()) @map("updated_at")

  folders Folder[]
  flows          Flow[]
  flowShares     FlowShare[]
  flowLikes   FlowLike[]
  flowSave		FlowSave[]
  flowComments       FlowComment[]
  notifications  Notification[]
  userFlowStates UserFlowState[] @relation("Owner_UserFlowState")
	refreshTokens RefreshToken[]
	PasswordResetToken PasswordResetToken[]

  @@map("users")
}

enum Role {
  admin
  user
}

enum Provider {
  local
  facebook
  google
}

// =====================
// Refresh Token
// =====================
model RefreshToken {
  id        String   @id @default(uuid()) @map("id")
  token     String   @unique @db.VarChar(512) @map("token")
  userId    String   @map("user_id")
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("refresh_tokens")
}


// =====================
// Password Reset Token
// =====================
model PasswordResetToken {
  id        String   @id @default(uuid()) @map("id")
  token     String   @unique @db.VarChar(512) @map("token") // token reset password
  userId    String   @map("user_id")
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at") // thời điểm hết hạn token
  createdAt DateTime @default(now()) @map("created_at")

  @@map("password_reset_tokens")
}


// =====================
// Folder
// =====================

model Folder {
  id        String   @id @default(uuid()) @map("id")
  userId    String   @map("user_id")
  name      String   @map("name")
  platform  Platform @map("platform")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  flows Flow[] 
  @@unique([userId, platform, name], name: "userId_platform_name")

  @@map("folders")
}

// =====================
// Flow
// =====================
model Flow {
  id               String   @id @default(uuid()) @map("id")
  userId           String   @map("user_id")
  pageId			String?  @map("page_id")
  folderId         String  @map("folder_id")
  pageAccessToken String?   @map("page_access_token") @db.Text
  name             String   @map("name")
  description      String?  @map("description")
  status           FlowStatus @default(draft) @map("status")
  logicJson        Json?     @map("logic_json")
  layoutJson       Json?     @map("layout_json")
  platform         Platform @map("platform")
  timeoutDuration  String?  @map("timeout_duration")
  startNodeId      String?   @map("start_node_id")
  timeoutJson      Json?  @map("timeout_json")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @map("updated_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder Folder @relation(fields: [folderId], references: [id], onDelete: Cascade)
  states  UserFlowState[]
  shares  FlowShare[]

  @@map("flows")
}

enum FlowStatus {
  draft
  published
}

enum Platform {
  facebook
  instagram
  zalo
}

// =====================
// UserFlowState
// =====================
enum UserFlowStatus {
  running
  pending
  cancelled
  completed
}

model UserFlowState {
  id             String         @id @default(uuid()) @map("id")
  platformUserId String         @map("platform_user_id")
  ownerUserId    String         @map("owner_user_id")
  flowId         String         @map("flow_id")
  pageId         String         @map("page_id")
  currentStep    String         @map("current_step")
  stepHistory Json? @map("step_history")
  variables      Json?          @map("variables")
  status         UserFlowStatus @default(running) @map("status")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  owner User @relation(fields: [ownerUserId], references: [id], name: "Owner_UserFlowState", onDelete: Cascade)
  flow  Flow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@map("user_flow_states")
}

// =====================
// FlowShare
// =====================
model FlowShare {
  id            String       @id @default(uuid()) @map("id")
  flowId        String       @map("flow_id")
  userId        String       @map("user_id")
  name          String       @map("name")
  description   String?      @map("description")
  thumbnail     String?       @map("thumbnail")
  status        FlowShareStatus @default(active) @map("status") 
  downloadCount Int          @default(0) @map("download_count")
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @default(now()) @updatedAt @map("updated_at")

  flow    Flow         @relation(fields: [flowId], references: [id])
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments FlowComment[] 
  likes    FlowLike[]    
  saves    FlowSave[]    

  @@map("flow_shares")
}

enum FlowShareStatus {
  active
  inactive
}

// =====================
// FlowComment
// =====================
model FlowComment {
  id          String       @id @default(uuid()) @map("id")
  flowShareId String       @map("flow_share_id")
  userId      String       @map("user_id")
  comment     String       @map("comment")
  parentId    String?      @map("parent_id")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @default(now()) @updatedAt @map("updated_at")

  flowShare FlowShare    @relation(fields: [flowShareId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    FlowComment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   FlowComment[] @relation("CommentReplies")

  @@map("flow_comments")
}

// =====================
// FlowLike
// =====================
model FlowLike {
  id          String     @id @default(uuid())
  flowShareId String
  userId      String
  createdAt   DateTime   @default(now())

  flowShare FlowShare @relation(fields: [flowShareId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([flowShareId, userId]) // mỗi user chỉ like 1 lần
  @@map("flow_likes")
}

// =====================
// FlowSave
// =====================
model FlowSave {
  id          String     @id @default(uuid())
  flowShareId String
  userId      String
  createdAt   DateTime   @default(now())

  flowShare FlowShare @relation(fields: [flowShareId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([flowShareId, userId]) // mỗi user chỉ save 1 lần
  @@map("flow_saves")
}


// =====================
// Notification
// =====================
model Notification {
  id        String @id @default(uuid()) @map("id")
  userId    String @map("user_id")
  type      NotificationType @map("type")
  message   String @map("message")
  avatar       String?  @map("avatar")
  relatedId  String @map("related_id") 
  read      Boolean @default(false) @map("read")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @map("updated_at")

   user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

enum NotificationType {
  comment
  reply
  download
  flow_done
  flow_cancelled
  new_user
  chat_message
}
